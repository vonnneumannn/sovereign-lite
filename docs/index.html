<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sovereign - Secure Chat</title>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --accent-light: #818cf8;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --border: #2a2a3a;
            --radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container { max-width: 600px; margin: 0 auto; width: 100%; flex: 1; display: flex; flex-direction: column; }
        header {
            padding: 16px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 {
            font-size: 1.25rem;
            background: linear-gradient(135deg, var(--accent-light), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .status { display: flex; align-items: center; gap: 8px; font-size: 0.875rem; color: var(--text-secondary); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); }
        .status-dot.connected { background: var(--success); }
        .status-dot.connecting { background: var(--warning); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .screen { display: none; flex: 1; flex-direction: column; padding: 24px 20px; }
        .screen.active { display: flex; }
        .centered { align-items: center; justify-content: center; text-align: center; }
        .logo { font-size: 4rem; margin-bottom: 16px; }
        h2 { font-size: 1.5rem; margin-bottom: 8px; }
        .subtitle { color: var(--text-secondary); margin-bottom: 32px; }
        .btn {
            padding: 14px 24px; border: none; border-radius: 8px; font-size: 1rem;
            font-weight: 500; cursor: pointer; transition: all 0.2s; width: 100%; margin-bottom: 12px;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .input-group { display: flex; gap: 12px; margin-bottom: 16px; }
        input { flex: 1; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 14px 16px; color: var(--text-primary); font-size: 1rem; }
        input:focus { outline: none; border-color: var(--accent); }
        .room-code-input { text-transform: uppercase; letter-spacing: 0.15em; text-align: center; font-weight: 600; font-size: 1.25rem; }
        .divider { display: flex; align-items: center; margin: 24px 0; color: var(--text-muted); }
        .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
        .divider span { padding: 0 16px; }
        select { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 14px 16px; color: var(--text-primary); font-size: 1rem; width: 100%; margin-bottom: 16px; }
        .info-box { background: rgba(99, 102, 241, 0.1); border: 1px solid var(--accent); border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; font-size: 0.875rem; color: var(--accent-light); }

        /* Chat styles */
        .chat-container { display: flex; flex: 1; overflow: hidden; }
        .chat-main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .chat-header {
            padding: 12px 16px; background: var(--bg-secondary); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .chat-header code { font-family: monospace; font-size: 0.875rem; color: var(--accent-light); }
        .chat-info { font-size: 0.75rem; color: var(--text-muted); }
        .chat-header-buttons { display: flex; gap: 8px; align-items: center; }
        .messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .system-msg { text-align: center; font-size: 0.75rem; color: var(--text-muted); padding: 8px; }
        .message { max-width: 85%; padding: 10px 14px; border-radius: 12px; }
        .message.ours { align-self: flex-end; background: var(--accent); color: white; border-bottom-right-radius: 4px; }
        .message.theirs { align-self: flex-start; background: var(--bg-tertiary); border-bottom-left-radius: 4px; }
        .message .alias { font-size: 0.7rem; font-weight: 600; color: var(--accent-light); margin-bottom: 4px; }
        .message.ours .alias { color: rgba(255,255,255,0.8); }
        .message .content { word-wrap: break-word; }
        .message .time { font-size: 0.625rem; opacity: 0.7; margin-top: 4px; }
        .chat-input { padding: 12px 16px; background: var(--bg-secondary); border-top: 1px solid var(--border); display: flex; gap: 8px; }
        .chat-input input { border-radius: 24px; }
        .chat-input .btn { width: auto; margin: 0; border-radius: 24px; padding: 12px 24px; }

        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--bg-tertiary); color: var(--text-primary); padding: 12px 24px; border-radius: 8px; z-index: 1000; }
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--error); }

        .peers-list { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }
        .github-link { position: fixed; top: 16px; right: 16px; color: var(--text-secondary); z-index: 100; }

        /* Leaderboard toggle button */
        .leaderboard-toggle, .voice-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--accent-light);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .leaderboard-toggle:hover, .voice-toggle:hover { background: var(--border); }
        .leaderboard-toggle.active { background: var(--accent); color: white; border-color: var(--accent); }
        .voice-toggle.active { background: var(--success); color: white; border-color: var(--success); }
        .voice-toggle.active:hover { background: #16a34a; }

        /* Voice channel styles */
        .voice-panel {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
            display: none;
        }
        .voice-panel.active { display: block; }
        .voice-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .voice-panel-title {
            font-size: 0.75rem;
            color: var(--success);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .voice-panel-title .pulse-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        .voice-participants {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .voice-participant {
            background: var(--bg-tertiary);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .voice-participant.speaking {
            border: 2px solid var(--success);
            animation: speaking 0.5s infinite alternate;
        }
        @keyframes speaking {
            from { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            to { box-shadow: 0 0 0 4px rgba(34, 197, 94, 0); }
        }
        .voice-participant .mic-icon { font-size: 0.875rem; }
        .voice-controls {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .voice-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .voice-btn:hover { background: var(--border); }
        .voice-btn.muted { color: var(--error); border-color: var(--error); }
        .voice-btn.leave { color: var(--error); }
        .voice-btn.leave:hover { background: rgba(239, 68, 68, 0.2); }

        /* Sidebar styles */
        .sidebar {
            width: 0;
            overflow: hidden;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            transition: width 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .sidebar.open { width: 320px; }
        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar-header h3 { font-size: 0.9rem; color: var(--accent-light); }
        .sidebar-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.25rem;
            padding: 4px;
        }
        .sidebar-close:hover { color: var(--text-primary); }
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        .sidebar-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }
        .sidebar-stat {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        .sidebar-stat-value { font-size: 1.25rem; font-weight: bold; color: var(--accent-light); }
        .sidebar-stat-label { font-size: 0.625rem; color: var(--text-muted); text-transform: uppercase; }
        .channel-list { display: flex; flex-direction: column; gap: 8px; }
        .channel-item {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .channel-item:hover { border-color: var(--accent); }
        .channel-item.active { border-color: var(--success); background: rgba(34, 197, 94, 0.1); }
        .channel-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .channel-item-code { font-family: monospace; font-weight: 600; color: var(--accent-light); }
        .channel-item-peers { font-size: 0.7rem; color: var(--success); }
        .channel-item-stats { font-size: 0.7rem; color: var(--text-muted); }
        .channel-item-preview { font-size: 0.75rem; color: var(--text-secondary); margin-top: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sidebar-loading { text-align: center; padding: 20px; color: var(--text-muted); }
        .sidebar-refresh {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.7rem;
        }
        .sidebar-refresh:hover { background: var(--border); }

        @media (max-width: 768px) {
            .sidebar { position: fixed; top: 0; right: 0; height: 100vh; z-index: 1000; width: 0; }
            .sidebar.open { width: 100%; max-width: 320px; }
        }
    </style>
</head>
<body>
    <a href="https://github.com/vonnneumannn/sovereign-lite" class="github-link" target="_blank">
        <svg height="24" width="24" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
        </svg>
    </a>

    <div class="container">
        <header>
            <h1>Sovereign</h1>
            <div class="status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Disconnected</span>
            </div>
        </header>

        <!-- Setup Screen -->
        <div id="setupScreen" class="screen active centered">
            <div class="logo">üîê</div>
            <h2>Sovereign Chat</h2>
            <p class="subtitle">Persistent channels with message history & voice</p>
            <div class="info-box">
                üì° Messages are stored on the relay. Join any channel to see its full history.
                <br><br>
                üéôÔ∏è Voice chat available in every channel!
            </div>
            <div style="width: 100%;">
                <button class="btn btn-primary" id="startBtn">Connect to Relay</button>
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div id="dashboardScreen" class="screen">
            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; margin-bottom: 24px;">
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">YOUR ALIAS</div>
                <code id="myAlias" style="color: var(--accent-light); font-size: 1.1rem;">Loading...</code>
            </div>

            <h3 style="margin-bottom: 16px;">Join or Create Channel</h3>
            <button class="btn btn-primary" id="createChannelBtn">Create New Channel</button>
            <div class="divider"><span>or join existing</span></div>
            <div class="input-group">
                <input type="text" id="joinCodeInput" class="room-code-input" placeholder="CLAUDE" maxlength="6">
                <button class="btn btn-secondary" id="joinChannelBtn" style="width: auto;">Join</button>
            </div>
            <p style="font-size: 0.75rem; color: var(--text-muted); text-align: center; margin-bottom: 24px;">
                Try joining channel <strong>CLAUDE</strong> to chat with Claude AI!
            </p>

            <!-- Leaderboard preview on dashboard -->
            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h4 style="font-size: 0.875rem; color: var(--text-secondary);">Active Channels</h4>
                    <button class="sidebar-refresh" id="dashboardRefreshBtn">Refresh</button>
                </div>
                <div id="dashboardChannelList" class="channel-list">
                    <div class="sidebar-loading">Loading channels...</div>
                </div>
            </div>
        </div>

        <!-- Chat Screen -->
        <div id="chatScreen" class="screen" style="padding: 0;">
            <div class="chat-container">
                <div class="chat-main">
                    <div class="chat-header">
                        <div>
                            <code id="channelCode">------</code>
                            <div class="chat-info"><span id="peerCount">0</span> online</div>
                        </div>
                        <div class="chat-header-buttons">
                            <button class="voice-toggle" id="voiceToggle" title="Join Voice Channel">
                                <span>üéôÔ∏è</span> Voice
                            </button>
                            <button class="leaderboard-toggle" id="leaderboardToggle">
                                <span>üìä</span> Channels
                            </button>
                            <button class="btn-secondary" id="endChatBtn" style="padding: 8px 16px; width: auto; margin: 0;">Leave</button>
                        </div>
                    </div>

                    <!-- Voice Panel -->
                    <div class="voice-panel" id="voicePanel">
                        <div class="voice-panel-header">
                            <div class="voice-panel-title">
                                <span class="pulse-dot"></span>
                                Voice Channel Active
                            </div>
                            <span id="voiceParticipantCount" style="font-size: 0.7rem; color: var(--text-muted);">0 in voice</span>
                        </div>
                        <div class="voice-participants" id="voiceParticipants">
                            <!-- Participants will be added here -->
                        </div>
                        <div class="voice-controls">
                            <button class="voice-btn" id="muteBtn">
                                <span>üé§</span> Mute
                            </button>
                            <button class="voice-btn leave" id="leaveVoiceBtn">
                                <span>üì¥</span> Leave Voice
                            </button>
                        </div>
                    </div>

                    <div class="messages" id="messagesContainer"></div>
                    <div class="chat-input">
                        <input type="text" id="messageInput" placeholder="Type a message... (use @CLAUDE to talk to Claude)">
                        <button class="btn btn-primary" id="sendBtn">Send</button>
                    </div>
                </div>

                <!-- Leaderboard Sidebar -->
                <div class="sidebar" id="leaderboardSidebar">
                    <div class="sidebar-header">
                        <h3>üìä Channel Leaderboard</h3>
                        <button class="sidebar-close" id="sidebarClose">&times;</button>
                    </div>
                    <div class="sidebar-content">
                        <div class="sidebar-stats" id="sidebarStats">
                            <div class="sidebar-stat">
                                <div class="sidebar-stat-value" id="statTotalChannels">-</div>
                                <div class="sidebar-stat-label">Total Channels</div>
                            </div>
                            <div class="sidebar-stat">
                                <div class="sidebar-stat-value" id="statActiveChannels">-</div>
                                <div class="sidebar-stat-label">Active</div>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span style="font-size: 0.75rem; color: var(--text-muted);">Click to join</span>
                            <button class="sidebar-refresh" id="sidebarRefreshBtn">Refresh</button>
                        </div>
                        <div class="channel-list" id="sidebarChannelList">
                            <div class="sidebar-loading">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden audio elements for voice chat -->
    <div id="audioContainer" style="display: none;"></div>

    <script>
        let ws = null;
        let channelCode = null;
        let myAlias = null;
        let peerCount = 0;
        let sidebarOpen = false;

        // Voice chat state
        let inVoice = false;
        let isMuted = false;
        let localStream = null;
        let peerConnections = {}; // peerId -> RTCPeerConnection
        let voiceParticipants = new Set();

        // ICE servers for WebRTC
        const iceServers = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function updateStatus(text, type = 'disconnected') {
            document.getElementById('statusText').textContent = text;
            const dot = document.getElementById('statusDot');
            dot.className = 'status-dot';
            if (type === 'connected') dot.classList.add('connected');
            else if (type === 'connecting') dot.classList.add('connecting');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function addMessage(alias, content, isOurs, timestamp) {
            const container = document.getElementById('messagesContainer');
            const msg = document.createElement('div');
            msg.className = 'message ' + (isOurs ? 'ours' : 'theirs');

            const escaped = content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const time = timestamp ? new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            msg.innerHTML = '<div class="alias">' + alias + '</div><div class="content">' + escaped + '</div><div class="time">' + time + '</div>';
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        function addSystemMessage(content) {
            const container = document.getElementById('messagesContainer');
            const msg = document.createElement('div');
            msg.className = 'system-msg';
            msg.textContent = content;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        function updatePeerCount(count) {
            peerCount = count;
            document.getElementById('peerCount').textContent = count;
        }

        function connectToRelay() {
            updateStatus('Connecting...', 'connecting');
            document.getElementById('startBtn').disabled = true;

            ws = new WebSocket('wss://clear-cat-32.deno.dev');

            ws.onopen = () => {
                updateStatus('Connected', 'connected');
                showScreen('dashboardScreen');
                loadLeaderboard();
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleMessage(msg);
            };

            ws.onerror = () => {
                updateStatus('Error', 'disconnected');
                showToast('Connection failed', 'error');
                document.getElementById('startBtn').disabled = false;
            };

            ws.onclose = () => {
                updateStatus('Disconnected');
                leaveVoiceChannel();
            };
        }

        function handleMessage(msg) {
            console.log('Received:', msg.type, msg.data);

            switch (msg.type) {
                case 'ChannelCreated':
                    channelCode = msg.data.code;
                    myAlias = msg.data.alias;
                    document.getElementById('myAlias').textContent = myAlias;
                    document.getElementById('channelCode').textContent = channelCode;
                    document.getElementById('messagesContainer').innerHTML = '';
                    updatePeerCount(1);

                    if (msg.data.history) {
                        msg.data.history.forEach(m => {
                            if (m.alias === 'SYSTEM') {
                                addSystemMessage(m.content);
                            } else {
                                addMessage(m.alias, m.content, m.alias === myAlias, m.timestamp);
                            }
                        });
                    }

                    showScreen('chatScreen');
                    showToast('Channel created: ' + channelCode, 'success');
                    loadLeaderboard();
                    break;

                case 'ChannelJoined':
                    channelCode = msg.data.code;
                    myAlias = msg.data.alias;
                    document.getElementById('myAlias').textContent = myAlias;
                    document.getElementById('channelCode').textContent = channelCode;
                    document.getElementById('messagesContainer').innerHTML = '';
                    updatePeerCount(msg.data.peer_count || 1);

                    if (msg.data.history) {
                        msg.data.history.forEach(m => {
                            if (m.alias === 'SYSTEM') {
                                addSystemMessage(m.content);
                            } else {
                                addMessage(m.alias, m.content, m.alias === myAlias, m.timestamp);
                            }
                        });
                    }

                    showScreen('chatScreen');
                    showToast('Joined ' + channelCode + ' as ' + myAlias, 'success');
                    loadLeaderboard();
                    break;

                case 'RoomCreated':
                    break;

                case 'Joined':
                    if (msg.data.peer_count) {
                        updatePeerCount(msg.data.peer_count);
                    }
                    break;

                case 'Broadcast':
                    const m = msg.data;
                    if (m.alias === 'SYSTEM') {
                        addSystemMessage(m.content);
                    } else {
                        addMessage(m.alias, m.content, m.alias === myAlias, m.timestamp);
                    }
                    break;

                case 'PeerJoined':
                    updatePeerCount(peerCount + 1);
                    if (msg.data && msg.data.alias) {
                        showToast(msg.data.alias + ' joined', 'success');
                    }
                    break;

                case 'PeerLeft':
                    updatePeerCount(Math.max(1, peerCount - 1));
                    if (msg.data && msg.data.alias) {
                        showToast(msg.data.alias + ' left', 'error');
                        // Remove from voice if they were in it
                        removeVoiceParticipant(msg.data.alias);
                    }
                    break;

                case 'Message':
                    if (msg.data && msg.data.data) {
                        addMessage('Unknown', msg.data.data, false);
                    }
                    break;

                case 'Error':
                    showToast(msg.data.message, 'error');
                    break;

                // Voice signaling messages
                case 'VoiceJoin':
                    handleVoiceJoin(msg.data);
                    break;

                case 'VoiceLeave':
                    handleVoiceLeave(msg.data);
                    break;

                case 'VoiceOffer':
                    handleVoiceOffer(msg.data);
                    break;

                case 'VoiceAnswer':
                    handleVoiceAnswer(msg.data);
                    break;

                case 'VoiceIceCandidate':
                    handleVoiceIceCandidate(msg.data);
                    break;
            }
        }

        function createChannel() {
            ws.send(JSON.stringify({ type: 'CreateChannel' }));
        }

        function joinChannel(code) {
            code = code || document.getElementById('joinCodeInput').value;
            code = code.toUpperCase().trim();
            if (!code) {
                showToast('Enter a channel code', 'error');
                return;
            }
            leaveVoiceChannel();
            ws.send(JSON.stringify({ type: 'JoinChannel', data: { code } }));
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            if (!content) return;

            ws.send(JSON.stringify({
                type: 'Broadcast',
                data: { content }
            }));

            input.value = '';
        }

        function leaveChannel() {
            leaveVoiceChannel();
            channelCode = null;
            document.getElementById('messagesContainer').innerHTML = '';
            closeSidebar();
            showScreen('dashboardScreen');
            loadLeaderboard();
        }

        // ==================== VOICE CHAT FUNCTIONS ====================

        async function joinVoiceChannel() {
            if (inVoice) return;

            try {
                // Request microphone access
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });

                inVoice = true;
                isMuted = false;

                // Update UI
                document.getElementById('voiceToggle').classList.add('active');
                document.getElementById('voicePanel').classList.add('active');
                document.getElementById('muteBtn').classList.remove('muted');
                document.getElementById('muteBtn').innerHTML = '<span>üé§</span> Mute';

                // Add self to participants
                addVoiceParticipant(myAlias, true);

                // Notify others
                ws.send(JSON.stringify({
                    type: 'Broadcast',
                    data: { content: `üéôÔ∏è ${myAlias} joined voice chat` }
                }));

                // Send voice join signal to initiate WebRTC with existing participants
                ws.send(JSON.stringify({
                    type: 'Broadcast',
                    data: {
                        content: JSON.stringify({
                            _voice: true,
                            type: 'VoiceJoin',
                            alias: myAlias
                        })
                    }
                }));

                showToast('Joined voice channel', 'success');

            } catch (err) {
                console.error('Failed to access microphone:', err);
                showToast('Could not access microphone', 'error');
            }
        }

        function leaveVoiceChannel() {
            if (!inVoice) return;

            // Stop local stream
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            // Close all peer connections
            Object.values(peerConnections).forEach(pc => pc.close());
            peerConnections = {};

            // Clear audio elements
            document.getElementById('audioContainer').innerHTML = '';

            // Update state
            inVoice = false;
            isMuted = false;
            voiceParticipants.clear();

            // Update UI
            document.getElementById('voiceToggle').classList.remove('active');
            document.getElementById('voicePanel').classList.remove('active');
            document.getElementById('voiceParticipants').innerHTML = '';
            updateVoiceParticipantCount();

            // Notify others
            if (ws && ws.readyState === WebSocket.OPEN && myAlias) {
                ws.send(JSON.stringify({
                    type: 'Broadcast',
                    data: { content: `üì¥ ${myAlias} left voice chat` }
                }));

                ws.send(JSON.stringify({
                    type: 'Broadcast',
                    data: {
                        content: JSON.stringify({
                            _voice: true,
                            type: 'VoiceLeave',
                            alias: myAlias
                        })
                    }
                }));
            }
        }

        function toggleMute() {
            if (!localStream) return;

            isMuted = !isMuted;
            localStream.getAudioTracks().forEach(track => {
                track.enabled = !isMuted;
            });

            const muteBtn = document.getElementById('muteBtn');
            if (isMuted) {
                muteBtn.classList.add('muted');
                muteBtn.innerHTML = '<span>üîá</span> Unmute';
            } else {
                muteBtn.classList.remove('muted');
                muteBtn.innerHTML = '<span>üé§</span> Mute';
            }

            // Update participant display
            updateVoiceParticipantDisplay(myAlias, !isMuted);
        }

        function addVoiceParticipant(alias, isSelf = false) {
            voiceParticipants.add(alias);
            updateVoiceParticipantCount();

            const container = document.getElementById('voiceParticipants');
            if (document.getElementById('voice-' + alias)) return;

            const el = document.createElement('div');
            el.className = 'voice-participant';
            el.id = 'voice-' + alias;
            el.innerHTML = `<span class="mic-icon">üé§</span> ${alias}${isSelf ? ' (you)' : ''}`;
            container.appendChild(el);
        }

        function removeVoiceParticipant(alias) {
            voiceParticipants.delete(alias);
            updateVoiceParticipantCount();

            const el = document.getElementById('voice-' + alias);
            if (el) el.remove();

            // Close peer connection if exists
            if (peerConnections[alias]) {
                peerConnections[alias].close();
                delete peerConnections[alias];
            }

            // Remove audio element
            const audio = document.getElementById('audio-' + alias);
            if (audio) audio.remove();
        }

        function updateVoiceParticipantCount() {
            document.getElementById('voiceParticipantCount').textContent = voiceParticipants.size + ' in voice';
        }

        function updateVoiceParticipantDisplay(alias, speaking) {
            const el = document.getElementById('voice-' + alias);
            if (el) {
                el.querySelector('.mic-icon').textContent = speaking ? 'üé§' : 'üîá';
            }
        }

        // WebRTC signaling handlers
        function handleVoiceJoin(data) {
            if (data.alias === myAlias || !inVoice) return;

            addVoiceParticipant(data.alias);

            // Create offer for the new participant
            createPeerConnection(data.alias, true);
        }

        function handleVoiceLeave(data) {
            removeVoiceParticipant(data.alias);
        }

        async function createPeerConnection(peerAlias, createOffer) {
            if (peerConnections[peerAlias]) return peerConnections[peerAlias];

            const pc = new RTCPeerConnection(iceServers);
            peerConnections[peerAlias] = pc;

            // Add local stream
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    pc.addTrack(track, localStream);
                });
            }

            // Handle incoming stream
            pc.ontrack = (event) => {
                const audio = document.createElement('audio');
                audio.id = 'audio-' + peerAlias;
                audio.srcObject = event.streams[0];
                audio.autoplay = true;
                document.getElementById('audioContainer').appendChild(audio);
            };

            // Handle ICE candidates
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({
                        type: 'Broadcast',
                        data: {
                            content: JSON.stringify({
                                _voice: true,
                                type: 'VoiceIceCandidate',
                                from: myAlias,
                                to: peerAlias,
                                candidate: event.candidate
                            })
                        }
                    }));
                }
            };

            pc.onconnectionstatechange = () => {
                console.log(`Connection to ${peerAlias}: ${pc.connectionState}`);
            };

            if (createOffer) {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                ws.send(JSON.stringify({
                    type: 'Broadcast',
                    data: {
                        content: JSON.stringify({
                            _voice: true,
                            type: 'VoiceOffer',
                            from: myAlias,
                            to: peerAlias,
                            offer: offer
                        })
                    }
                }));
            }

            return pc;
        }

        async function handleVoiceOffer(data) {
            if (data.to !== myAlias || !inVoice) return;

            addVoiceParticipant(data.from);

            const pc = await createPeerConnection(data.from, false);
            await pc.setRemoteDescription(new RTCSessionDescription(data.offer));

            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            ws.send(JSON.stringify({
                type: 'Broadcast',
                data: {
                    content: JSON.stringify({
                        _voice: true,
                        type: 'VoiceAnswer',
                        from: myAlias,
                        to: data.from,
                        answer: answer
                    })
                }
            }));
        }

        async function handleVoiceAnswer(data) {
            if (data.to !== myAlias) return;

            const pc = peerConnections[data.from];
            if (pc) {
                await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
            }
        }

        async function handleVoiceIceCandidate(data) {
            if (data.to !== myAlias) return;

            const pc = peerConnections[data.from];
            if (pc) {
                await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
            }
        }

        // Override handleMessage to detect voice signaling in broadcasts
        const originalHandleMessage = handleMessage;
        handleMessage = function(msg) {
            // Check if it's a voice signaling message embedded in broadcast
            if (msg.type === 'Broadcast' && msg.data && msg.data.content) {
                try {
                    const content = msg.data.content;
                    if (content.startsWith('{') && content.includes('"_voice":true')) {
                        const voiceData = JSON.parse(content);
                        if (voiceData._voice) {
                            switch (voiceData.type) {
                                case 'VoiceJoin':
                                    handleVoiceJoin(voiceData);
                                    return;
                                case 'VoiceLeave':
                                    handleVoiceLeave(voiceData);
                                    return;
                                case 'VoiceOffer':
                                    handleVoiceOffer(voiceData);
                                    return;
                                case 'VoiceAnswer':
                                    handleVoiceAnswer(voiceData);
                                    return;
                                case 'VoiceIceCandidate':
                                    handleVoiceIceCandidate(voiceData);
                                    return;
                            }
                        }
                    }
                } catch (e) {
                    // Not JSON, treat as normal message
                }
            }
            originalHandleMessage(msg);
        };

        // ==================== SIDEBAR FUNCTIONS ====================

        function toggleSidebar() {
            const sidebar = document.getElementById('leaderboardSidebar');
            const toggle = document.getElementById('leaderboardToggle');
            sidebarOpen = !sidebarOpen;
            sidebar.classList.toggle('open', sidebarOpen);
            toggle.classList.toggle('active', sidebarOpen);
            if (sidebarOpen) {
                loadLeaderboard();
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('leaderboardSidebar');
            const toggle = document.getElementById('leaderboardToggle');
            sidebarOpen = false;
            sidebar.classList.remove('open');
            toggle.classList.remove('active');
        }

        async function loadLeaderboard() {
            try {
                const response = await fetch('https://clear-cat-32.deno.dev/api/stats');
                const data = await response.json();

                document.getElementById('statTotalChannels').textContent = data.totalChannels || 0;
                document.getElementById('statActiveChannels').textContent = data.activeChannels || 0;

                const leaderboard = data.leaderboard || [];
                renderChannelList('sidebarChannelList', leaderboard);
                renderChannelList('dashboardChannelList', leaderboard.slice(0, 5));

            } catch (e) {
                console.error('Failed to load leaderboard:', e);
                document.getElementById('sidebarChannelList').innerHTML = '<div class="sidebar-loading">Failed to load</div>';
                document.getElementById('dashboardChannelList').innerHTML = '<div class="sidebar-loading">Failed to load</div>';
            }
        }

        function renderChannelList(containerId, channels) {
            const container = document.getElementById(containerId);

            if (!channels || channels.length === 0) {
                container.innerHTML = '<div class="sidebar-loading">No channels yet</div>';
                return;
            }

            container.innerHTML = channels.map(ch => {
                const isActive = ch.currentPeers > 0;
                const isCurrent = ch.code === channelCode;
                const lastMsg = ch.recentMessages && ch.recentMessages.length > 0
                    ? ch.recentMessages[ch.recentMessages.length - 1]
                    : null;
                const preview = lastMsg
                    ? `${lastMsg.alias}: ${lastMsg.preview}`
                    : 'No messages yet';

                return `
                    <div class="channel-item ${isCurrent ? 'active' : ''}" onclick="joinChannel('${ch.code}')">
                        <div class="channel-item-header">
                            <span class="channel-item-code">${ch.code}</span>
                            <span class="channel-item-peers">${isActive ? 'üü¢ ' + ch.currentPeers + ' online' : '‚ö´ offline'}</span>
                        </div>
                        <div class="channel-item-stats">
                            ${ch.messageCount} messages ¬∑ ${ch.totalPeersEver} total visitors
                        </div>
                        <div class="channel-item-preview">${preview}</div>
                    </div>
                `;
            }).join('');
        }

        // Event listeners
        document.getElementById('startBtn').onclick = connectToRelay;
        document.getElementById('createChannelBtn').onclick = createChannel;
        document.getElementById('joinChannelBtn').onclick = () => joinChannel();
        document.getElementById('joinCodeInput').onkeypress = (e) => { if (e.key === 'Enter') joinChannel(); };
        document.getElementById('sendBtn').onclick = sendMessage;
        document.getElementById('messageInput').onkeypress = (e) => { if (e.key === 'Enter') sendMessage(); };
        document.getElementById('endChatBtn').onclick = leaveChannel;
        document.getElementById('leaderboardToggle').onclick = toggleSidebar;
        document.getElementById('sidebarClose').onclick = closeSidebar;
        document.getElementById('sidebarRefreshBtn').onclick = loadLeaderboard;
        document.getElementById('dashboardRefreshBtn').onclick = loadLeaderboard;

        // Voice controls
        document.getElementById('voiceToggle').onclick = () => {
            if (inVoice) {
                leaveVoiceChannel();
            } else {
                joinVoiceChannel();
            }
        };
        document.getElementById('muteBtn').onclick = toggleMute;
        document.getElementById('leaveVoiceBtn').onclick = leaveVoiceChannel;
    </script>
</body>
</html>
