<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sovereign - Secure Chat</title>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --accent-light: #818cf8;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --border: #2a2a3a;
            --radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container { max-width: 600px; margin: 0 auto; width: 100%; flex: 1; display: flex; flex-direction: column; }
        header {
            padding: 16px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 {
            font-size: 1.25rem;
            background: linear-gradient(135deg, var(--accent-light), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .status { display: flex; align-items: center; gap: 8px; font-size: 0.875rem; color: var(--text-secondary); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); }
        .status-dot.connected { background: var(--success); }
        .status-dot.connecting { background: var(--warning); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .screen { display: none; flex: 1; flex-direction: column; padding: 24px 20px; }
        .screen.active { display: flex; }
        .centered { align-items: center; justify-content: center; text-align: center; }
        .logo { font-size: 4rem; margin-bottom: 16px; }
        h2 { font-size: 1.5rem; margin-bottom: 8px; }
        .subtitle { color: var(--text-secondary); margin-bottom: 32px; }
        .btn {
            padding: 14px 24px; border: none; border-radius: 8px; font-size: 1rem;
            font-weight: 500; cursor: pointer; transition: all 0.2s; width: 100%; margin-bottom: 12px;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .input-group { display: flex; gap: 12px; margin-bottom: 16px; }
        input { flex: 1; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 14px 16px; color: var(--text-primary); font-size: 1rem; }
        input:focus { outline: none; border-color: var(--accent); }
        .room-code-input { text-transform: uppercase; letter-spacing: 0.15em; text-align: center; font-weight: 600; font-size: 1.25rem; }
        .divider { display: flex; align-items: center; margin: 24px 0; color: var(--text-muted); }
        .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
        .divider span { padding: 0 16px; }
        select { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 14px 16px; color: var(--text-primary); font-size: 1rem; width: 100%; margin-bottom: 16px; }
        .info-box { background: rgba(99, 102, 241, 0.1); border: 1px solid var(--accent); border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; font-size: 0.875rem; color: var(--accent-light); }

        /* Chat styles */
        .chat-header {
            padding: 12px 16px; background: var(--bg-secondary); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .chat-header code { font-family: monospace; font-size: 0.875rem; color: var(--accent-light); }
        .chat-info { font-size: 0.75rem; color: var(--text-muted); }
        .messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .system-msg { text-align: center; font-size: 0.75rem; color: var(--text-muted); padding: 8px; }
        .message { max-width: 85%; padding: 10px 14px; border-radius: 12px; }
        .message.ours { align-self: flex-end; background: var(--accent); color: white; border-bottom-right-radius: 4px; }
        .message.theirs { align-self: flex-start; background: var(--bg-tertiary); border-bottom-left-radius: 4px; }
        .message .alias { font-size: 0.7rem; font-weight: 600; color: var(--accent-light); margin-bottom: 4px; }
        .message.ours .alias { color: rgba(255,255,255,0.8); }
        .message .content { word-wrap: break-word; }
        .message .time { font-size: 0.625rem; opacity: 0.7; margin-top: 4px; }
        .chat-input { padding: 12px 16px; background: var(--bg-secondary); border-top: 1px solid var(--border); display: flex; gap: 8px; }
        .chat-input input { border-radius: 24px; }
        .chat-input .btn { width: auto; margin: 0; border-radius: 24px; padding: 12px 24px; }

        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--bg-tertiary); color: var(--text-primary); padding: 12px 24px; border-radius: 8px; z-index: 1000; }
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--error); }

        .peers-list { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }
        .github-link { position: fixed; top: 16px; right: 16px; color: var(--text-secondary); }
    </style>
</head>
<body>
    <a href="https://github.com/vonnneumannn/sovereign-lite" class="github-link" target="_blank">
        <svg height="24" width="24" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
        </svg>
    </a>

    <div class="container">
        <header>
            <h1>Sovereign</h1>
            <div class="status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Disconnected</span>
            </div>
        </header>

        <!-- Setup Screen -->
        <div id="setupScreen" class="screen active centered">
            <div class="logo">üîê</div>
            <h2>Sovereign Chat</h2>
            <p class="subtitle">Persistent channels with message history</p>
            <div class="info-box">
                üì° Messages are stored on the relay. Join any channel to see its full history.
                <br><br>
                <a href="https://clear-cat-32.deno.dev" target="_blank" style="color: var(--accent-light);">View Channel Leaderboard ‚Üí</a>
            </div>
            <div style="width: 100%;">
                <button class="btn btn-primary" id="startBtn">Connect to Relay</button>
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div id="dashboardScreen" class="screen">
            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; margin-bottom: 24px;">
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">YOUR ALIAS</div>
                <code id="myAlias" style="color: var(--accent-light); font-size: 1.1rem;">Loading...</code>
            </div>

            <h3 style="margin-bottom: 16px;">Join or Create Channel</h3>
            <button class="btn btn-primary" id="createChannelBtn">Create New Channel</button>
            <div class="divider"><span>or join existing</span></div>
            <div class="input-group">
                <input type="text" id="joinCodeInput" class="room-code-input" placeholder="CLAUDE" maxlength="6">
                <button class="btn btn-secondary" id="joinChannelBtn" style="width: auto;">Join</button>
            </div>
            <p style="font-size: 0.75rem; color: var(--text-muted); text-align: center;">
                Try joining channel <strong>CLAUDE</strong> to chat with Claude AI!
            </p>
        </div>

        <!-- Chat Screen -->
        <div id="chatScreen" class="screen" style="padding: 0;">
            <div class="chat-header">
                <div>
                    <code id="channelCode">------</code>
                    <div class="chat-info"><span id="peerCount">0</span> online</div>
                </div>
                <button class="btn-secondary" id="endChatBtn" style="padding: 8px 16px; width: auto; margin: 0;">Leave</button>
            </div>
            <div class="messages" id="messagesContainer"></div>
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Type a message... (use @CLAUDE to talk to Claude)">
                <button class="btn btn-primary" id="sendBtn">Send</button>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let channelCode = null;
        let myAlias = null;
        let peerCount = 0;

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function updateStatus(text, type = 'disconnected') {
            document.getElementById('statusText').textContent = text;
            const dot = document.getElementById('statusDot');
            dot.className = 'status-dot';
            if (type === 'connected') dot.classList.add('connected');
            else if (type === 'connecting') dot.classList.add('connecting');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function addMessage(alias, content, isOurs, timestamp) {
            const container = document.getElementById('messagesContainer');
            const msg = document.createElement('div');
            msg.className = 'message ' + (isOurs ? 'ours' : 'theirs');

            const escaped = content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const time = timestamp ? new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            msg.innerHTML = '<div class="alias">' + alias + '</div><div class="content">' + escaped + '</div><div class="time">' + time + '</div>';
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        function addSystemMessage(content) {
            const container = document.getElementById('messagesContainer');
            const msg = document.createElement('div');
            msg.className = 'system-msg';
            msg.textContent = content;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        function updatePeerCount(count) {
            peerCount = count;
            document.getElementById('peerCount').textContent = count;
        }

        function connectToRelay() {
            updateStatus('Connecting...', 'connecting');
            document.getElementById('startBtn').disabled = true;

            ws = new WebSocket('wss://clear-cat-32.deno.dev');

            ws.onopen = () => {
                updateStatus('Connected', 'connected');
                showScreen('dashboardScreen');
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleMessage(msg);
            };

            ws.onerror = () => {
                updateStatus('Error', 'disconnected');
                showToast('Connection failed', 'error');
                document.getElementById('startBtn').disabled = false;
            };

            ws.onclose = () => {
                updateStatus('Disconnected');
            };
        }

        function handleMessage(msg) {
            console.log('Received:', msg.type, msg.data);

            switch (msg.type) {
                case 'ChannelCreated':
                    channelCode = msg.data.code;
                    myAlias = msg.data.alias;
                    document.getElementById('myAlias').textContent = myAlias;
                    document.getElementById('channelCode').textContent = channelCode;
                    document.getElementById('messagesContainer').innerHTML = '';
                    updatePeerCount(1);

                    // Load history
                    if (msg.data.history) {
                        msg.data.history.forEach(m => {
                            if (m.alias === 'SYSTEM') {
                                addSystemMessage(m.content);
                            } else {
                                addMessage(m.alias, m.content, m.alias === myAlias, m.timestamp);
                            }
                        });
                    }

                    showScreen('chatScreen');
                    showToast('Channel created: ' + channelCode, 'success');
                    break;

                case 'ChannelJoined':
                    channelCode = msg.data.code;
                    myAlias = msg.data.alias;
                    document.getElementById('myAlias').textContent = myAlias;
                    document.getElementById('channelCode').textContent = channelCode;
                    document.getElementById('messagesContainer').innerHTML = '';
                    updatePeerCount(msg.data.peer_count || 1);

                    // Load history
                    if (msg.data.history) {
                        msg.data.history.forEach(m => {
                            if (m.alias === 'SYSTEM') {
                                addSystemMessage(m.content);
                            } else {
                                addMessage(m.alias, m.content, m.alias === myAlias, m.timestamp);
                            }
                        });
                    }

                    showScreen('chatScreen');
                    showToast('Joined ' + channelCode + ' as ' + myAlias, 'success');
                    break;

                case 'RoomCreated':
                    // Backward compat - ignore, we use ChannelCreated
                    break;

                case 'Joined':
                    // Backward compat - use peer count
                    if (msg.data.peer_count) {
                        updatePeerCount(msg.data.peer_count);
                    }
                    break;

                case 'Broadcast':
                    // New message from channel
                    const m = msg.data;
                    if (m.alias === 'SYSTEM') {
                        addSystemMessage(m.content);
                    } else {
                        addMessage(m.alias, m.content, m.alias === myAlias, m.timestamp);
                    }
                    break;

                case 'PeerJoined':
                    updatePeerCount(peerCount + 1);
                    if (msg.data && msg.data.alias) {
                        showToast(msg.data.alias + ' joined', 'success');
                    }
                    break;

                case 'PeerLeft':
                    updatePeerCount(Math.max(1, peerCount - 1));
                    if (msg.data && msg.data.alias) {
                        showToast(msg.data.alias + ' left', 'error');
                    }
                    break;

                case 'Message':
                    // Old format - try to display
                    if (msg.data && msg.data.data) {
                        addMessage('Unknown', msg.data.data, false);
                    }
                    break;

                case 'Error':
                    showToast(msg.data.message, 'error');
                    break;
            }
        }

        function createChannel() {
            ws.send(JSON.stringify({ type: 'CreateChannel' }));
        }

        function joinChannel() {
            const code = document.getElementById('joinCodeInput').value.toUpperCase().trim();
            if (!code) {
                showToast('Enter a channel code', 'error');
                return;
            }
            ws.send(JSON.stringify({ type: 'JoinChannel', data: { code } }));
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            if (!content) return;

            ws.send(JSON.stringify({
                type: 'Broadcast',
                data: { content }
            }));

            input.value = '';
        }

        function leaveChannel() {
            channelCode = null;
            document.getElementById('messagesContainer').innerHTML = '';
            showScreen('dashboardScreen');
        }

        // Event listeners
        document.getElementById('startBtn').onclick = connectToRelay;
        document.getElementById('createChannelBtn').onclick = createChannel;
        document.getElementById('joinChannelBtn').onclick = joinChannel;
        document.getElementById('joinCodeInput').onkeypress = (e) => { if (e.key === 'Enter') joinChannel(); };
        document.getElementById('sendBtn').onclick = sendMessage;
        document.getElementById('messageInput').onkeypress = (e) => { if (e.key === 'Enter') sendMessage(); };
        document.getElementById('endChatBtn').onclick = leaveChannel;
    </script>
</body>
</html>
